<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadrlar va Ish Haqi - FAXR MADAD KONSALT</title>
    <style>
        :root {
            /* BLUE/SLATE THEME */
            --primary-color: #1e40af;
            /* Blue 800 */
            --bg-color: #f8fafc;
            /* Slate 50 */
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --border-color: #cbd5e1;
            --success: #16a34a;
            --danger: #dc2626;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 1.4rem;
        }

        /* LAYOUT */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* FORMS & INPUTS */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-ghost {
            background: transparent;
            color: inherit;
            border: 1px solid var(--border-color);
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        th {
            background: #f1f5f9;
        }

        .num {
            text-align: right;
            font-family: monospace;
            font-weight: 600;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
            font-weight: bold;
        }

        /* PRINT */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
            }

            .card {
                border: none;
                shadow: none;
                padding: 0;
            }

            .container {
                max-width: 100%;
                margin: 0;
            }

            table {
                width: 100%;
                border: 1px solid black;
            }

            th,
            td {
                border: 1px solid black;
            }
        }
    </style>
</head>

<body>

    <header class="no-print">
        <div>
            <h1>Kadrlar va Ish Haqi (6700)</h1>
            <small>"FAXR MADAD KONSALT" MChJ</small>
        </div>
        <div>
            <span style="font-size:0.9rem; margin-right:10px;" id="current-date"></span>
        </div>
    </header>

    <div class="container">

        <div class="tabs no-print">
            <button class="tab-btn active" onclick="setTab('kadrlar')">üë®‚Äçüíº Xodimlar (Kadr)</button>
            <button class="tab-btn" onclick="setTab('payroll')">üí∞ Ish Haqi (Tabel)</button>
            <button class="tab-btn" onclick="setTab('tax')">üìä Soliq Hisoboti</button>
            <button class="tab-btn" onclick="setTab('shtat')">üè¢ Shtat Jadvali</button>
        </div>

        <!-- === KADRLAR TAB === -->
        <div id="tab-kadrlar">
            <div class="card no-print">
                <h3>Yangi Xodim Qo'shish</h3>
                <form id="emp-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Xodim F.I.SH</label>
                            <input type="text" id="e-name" placeholder="Masalan: Aliyev Vali" required>
                        </div>
                        <div class="form-group">
                            <label>Bandlik Turi</label>
                            <select id="e-type" onchange="toggleEmpInputs()">
                                <option value="Shtat">Shtat (Doimiy)</option>
                                <option value="Ishbay">Ishbay (Bajarilgan ishga)</option>
                                <option value="GPD">GPD (Shartnoma)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Soliq Imtiyozi (JShODS)</label>
                            <select id="e-exemption">
                                <option value="">Imtiyoz mavjud emas</option>
                                <option value="380">SK 380-modda (Nogironlik - 1.41 BRV)</option>
                                <option value="378_edu">SK 378-modda (Kontrakt to'lovi)</option>
                                <option value="378_loan">SK 378-modda (Ipoteka krediti)</option>
                            </select>
                        </div>
                        <div class="form-group" id="grp-pos-select">
                            <label>Lavozim (Shtatdan)</label>
                            <select id="e-pos-select">
                                <option value="">Tanlang...</option>
                            </select>
                        </div>
                        <div class="form-group" id="grp-pos-text" style="display:none;">
                            <label>Vazifasi / Ish Nomi</label>
                            <input type="text" id="e-pos-text">
                        </div>
                        <div class="form-group">
                            <label>Oylik Maosh / Stavka</label>
                            <input type="number" id="e-salary" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Sana</label>
                            <input type="date" id="e-date" required>
                        </div>
                    </div>
                    <div style="margin-top:15px; text-align:right;">
                        <button type="button" onclick="resetForm()" class="btn btn-ghost">Bekor qilish</button>
                        <button type="submit" class="btn btn-primary">Saqlash</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h3>Xodimlar Ro'yxati</h3>
                <div style="overflow-x:auto;">
                    <table id="emp-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>F.I.SH</th>
                                <th>Lavozim</th>
                                <th>Turi</th>
                                <th>Sana</th>
                                <th class="num">Oylik (Plan)</th>
                                <th class="no-print">Amal</th>
                            </tr>
                        </thead>
                        <tbody id="emp-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- === PAYROLL TAB === -->
        <div id="tab-payroll" style="display:none;">
            <div class="card no-print">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <label>Hisobot Oyi:</label>
                        <input type="month" id="pay-month" onchange="loadPayroll()">
                        <button onclick="calculatePayroll()" class="btn btn-primary">‚öôÔ∏è Hisoblash</button>
                    </div>
                    <button onclick="window.print()" class="btn btn-success">üñ®Ô∏è Vedomostni Chop Etish</button>
                </div>
            </div>

            <div class="card" id="payroll-sheet">
                <div class="show-print text-center">
                    <h2 style="text-align:center;">ISH HAQI TO'LASH QAYDNOMASI</h2>
                    <p style="text-align:center;" id="sheet-month-label"></p>
                </div>

                <div style="overflow-x:auto;">
                    <table id="pay-table">
                        <thead>
                            <tr style="background:#e0f2fe;">
                                <th>‚Ññ</th>
                                <th>F.I.SH</th>
                                <th class="num">Hisoblangan<br>(Gross)</th>
                                <th class="num">JShODS (12%)<br><small>Daromad Solig'i</small></th>
                                <th class="num">INPS (0.1%)<br><small>Xalq Banki</small></th>
                                <th class="num">Netto<br>(Qo'lga)</th>
                                <th class="num" style="background:#fefce8;">Ijtimoiy Soliq<br>(12% Korxona)</th>
                                <th class="no-print">Tahrirlash</th>
                                <th class="print-only" style="display:none;">Imzo</th>
                            </tr>
                        </thead>
                        <tbody id="pay-tbody"></tbody>
                        <tfoot style="font-weight:bold; background:#e0f2fe;">
                            <tr>
                                <td colspan="2">JAMI:</td>
                                <td class="num" id="t-gross">0</td>
                                <td class="num" id="t-tax">0</td>
                                <td class="num" id="t-inps">0</td>
                                <td class="num" id="t-net">0</td>
                                <td class="num" id="t-social">0</td>
                                <td class="no-print"></td>
                                <td class="print-only" style="display:none;"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- === SHTAT TAB === -->
        <div id="tab-shtat" style="display:none;">
            <div class="card no-print">
                <h3>Shtat Birligi Qo'shish</h3>
                <form id="shtat-form" style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="s-dept" placeholder="Bo'lim (masalan: Buxgalteriya)" required>
                    <input type="text" id="s-pos" placeholder="Lavozim" required>
                    <input type="number" id="s-salary" placeholder="Oylik Maosh" required>
                    <button type="submit" class="btn btn-primary">Qo'shish</button>
                </form>
            </div>
            <div class="card">
                <h3>Shtat Jadvali</h3>
                <table id="shtat-table">
                    <thead>
                        <tr>
                            <th>Bo'lim</th>
                            <th>Lavozim</th>
                            <th class="num">Oylik</th>
                            <th class="no-print">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="shtat-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- === TAX REPORT TAB === -->
        <div id="tab-tax" style="display:none;">
            <div class="card no-print">
                <h3>Soliq Hisoboti (Shakl 11101_13)</h3>
                <p style="font-size:0.9rem; color:#666;">Ushbu hisobot Ish Haqi ma'lumotlari asosida avtomatik
                    shakllanadi.</p>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="generateTaxReport()" class="btn btn-primary">üîÑ Hisobotni Yangilash</button>
                    <button onclick="window.print()" class="btn btn-success">üñ®Ô∏è Chop etish</button>
                </div>
            </div>

            <div class="card">
                <h2 style="text-align:center; font-size:1.1rem; margin-bottom:5px;">Jismoniy shaxslardan olinadigan
                    daromad solig'i hisob-kitobi (Ilova)</h2>
                <div style="text-align:center; margin-bottom:15px; font-weight:bold;" id="tax-month-label"></div>

                <table id="tax-report-table">
                    <thead style="background:#f1f5f9; font-size:0.85rem;">
                        <tr>
                            <th rowspan="2">#</th>
                            <th rowspan="2">F.I.SH</th>
                            <th rowspan="2">Hisoblangan Daromad<br>(010)</th>
                            <th colspan="2" style="text-align:center">Soliq Solinmaydigan (020)</th>
                            <th rowspan="2">Soliq Bazasi<br>(030)</th>
                            <th rowspan="2">Soliq Summasi<br>(040)</th>
                            <th rowspan="2">INPS (0.1%)<br>(Ma'l. uchun)</th>
                        </tr>
                        <tr>
                            <th>Summa</th>
                            <th>Asos (Hujjat)</th>
                        </tr>
                    </thead>
                    <tbody id="tax-tbody"></tbody>
                    <tfoot style="background:#e2e8f0; font-weight:bold;">
                        <tr id="tax-tfoot">
                            <td colspan="2">JAMI:</td>
                            <td class="num">0</td>
                            <td class="num">0</td>
                            <td></td>
                            <td class="num">0</td>
                            <td class="num">0</td>
                            <td class="num">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </div>

    <!-- PRINT STYLES -->
    <style>
        @media print {
            .print-only {
                display: table-cell !important;
            }
        }
    </style>

    <script>
        // --- DATA ---
        let employees = JSON.parse(localStorage.getItem('k_employees') || '[]');
        let shtat = JSON.parse(localStorage.getItem('k_shtat') || '[]');
        // Payroll structure: { '2025-01': [ {empId, gross, tax, inps, net, social}, ... ], ... }
        let payrolls = JSON.parse(localStorage.getItem('k_payrolls') || '{}');
        let editingId = null;

        window.onload = function () {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString();
            document.getElementById('pay-month').value = new Date().toISOString().slice(0, 7);

            renderShtat();
            renderEmployees(); // also updates select options
            loadPayroll();
        };

        function setTab(tab) {
            ['kadrlar', 'payroll', 'shtat', 'tax'].forEach(t => {
                document.getElementById('tab-' + t).style.display = (t === tab ? 'block' : 'none');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // --- SHTAT ---
        document.getElementById('shtat-form').onsubmit = function (e) {
            e.preventDefault();
            shtat.push({
                id: Date.now(),
                dept: document.getElementById('s-dept').value,
                pos: document.getElementById('s-pos').value,
                salary: parseFloat(document.getElementById('s-salary').value)
            });
            saveShtat();
            this.reset();
            renderShtat();
            renderEmployees(); // update select
        };

        function renderShtat() {
            const tbody = document.getElementById('shtat-tbody');
            tbody.innerHTML = shtat.map(s => `
                <tr>
                    <td>${s.dept}</td>
                    <td>${s.pos}</td>
                    <td class="num">${s.salary.toLocaleString()}</td>
                    <td class="no-print"><button onclick="delShtat(${s.id})" class="btn-danger btn" style="padding:2px 5px;">x</button></td>
                </tr>
            `).join('');

            // Update Select
            const sel = document.getElementById('e-pos-select');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">-- Shtatdan tanlang --</option>' +
                shtat.map(s => `<option value="${s.id}">${s.pos} (${s.salary})</option>`).join('');
            sel.value = currentVal;
        }

        document.getElementById('e-pos-select').onchange = function () {
            const s = shtat.find(x => x.id == this.value);
            if (s) document.getElementById('e-salary').value = s.salary;
        };

        function saveShtat() { localStorage.setItem('k_shtat', JSON.stringify(shtat)); }
        function delShtat(id) { if (confirm('Ochirilsinmi?')) { shtat = shtat.filter(x => x.id !== id); saveShtat(); renderShtat(); } }


        // --- EMPLOYEES ---
        function toggleEmpInputs() {
            const type = document.getElementById('e-type').value;
            const isShtat = type === 'Shtat';
            document.getElementById('grp-pos-select').style.display = isShtat ? 'block' : 'none';
            document.getElementById('grp-pos-text').style.display = isShtat ? 'none' : 'block';
        }

        document.getElementById('emp-form').onsubmit = function (e) {
            e.preventDefault();
            const type = document.getElementById('e-type').value;
            let posName = "";

            if (type === 'Shtat') {
                const sId = document.getElementById('e-pos-select').value;
                const s = shtat.find(x => x.id == sId);
                posName = s ? s.pos : "Aniqlanmagan";
            } else {
                posName = document.getElementById('e-pos-text').value;
            }

            const emp = {
                id: editingId || Date.now(),
                name: document.getElementById('e-name').value,
                type: type,
                position: posName,
                salary: parseFloat(document.getElementById('e-salary').value) || 0,
                date: document.getElementById('e-date').value
            };

            if (editingId) {
                const idx = employees.findIndex(x => x.id === editingId);
                employees[idx] = emp;
            } else {
                employees.push(emp);
            }
            saveEmp();
            resetForm();
            renderEmployees();
        };

        function renderEmployees() {
            const tbody = document.getElementById('emp-tbody');
            tbody.innerHTML = employees.map((e, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td><b>${e.name}</b></td>
                    <td>${e.position}</td>
                    <td><span class="badge" style="background:${getBadgeColor(e.type)}">${e.type}</span></td>
                    <td>${e.date}</td>
                    <td class="num">${e.salary.toLocaleString()}</td>
                    <td class="no-print">
                        <button onclick="editEmp(${e.id})" class="btn-ghost btn" style="padding:2px 5px;">‚úèÔ∏è</button>
                        <button onclick="delEmp(${e.id})" class="btn-danger btn" style="padding:2px 5px;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function getBadgeColor(t) {
            if (t === 'Shtat') return '#2563eb'; // blue
            if (t === 'Ishbay') return '#f59e0b'; // orange
            return '#9333ea'; // purple
        }

        function saveEmp() { localStorage.setItem('k_employees', JSON.stringify(employees)); }
        function editEmp(id) {
            const e = employees.find(x => x.id === id);
            editingId = id;
            document.getElementById('e-name').value = e.name;
            document.getElementById('e-type').value = e.type;
            toggleEmpInputs();
            if (e.type === 'Shtat') {
                // Try to find matching shtat by position name? Or keep simple text
                // Since we didn't save shtatId, we just show value in salary
                // For simplified UX, let user re-select if needed
            } else {
                document.getElementById('e-pos-text').value = e.position;
            }
            document.getElementById('e-salary').value = e.salary;
            document.getElementById('e-date').value = e.date;
        }
        function resetForm() { editingId = null; document.getElementById('emp-form').reset(); toggleEmpInputs(); }
        function delEmp(id) { if (confirm('Ochirilsinmi?')) { employees = employees.filter(x => x.id !== id); saveEmp(); renderEmployees(); } }


        // --- PAYROLL ---
        function loadPayroll() {
            const m = document.getElementById('pay-month').value;
            document.getElementById('sheet-month-label').innerText = m + " oyi uchun";

            // If exists, load from storage. If not, don't auto-calc yet.
            const data = payrolls[m] || [];
            renderPayrollTable(data);
        }

        function calculatePayroll() {
            const m = document.getElementById('pay-month').value;
            if (!confirm(m + " oyi uchun hisoblashni amalga oshirasizmi? (Eski ma'lumotlar yangilanadi)")) return;

            const newData = employees.map(e => {
                const gross = e.salary; // Assume full month for now
                // 12% Income Tax (includes INPS logic or separate?)
                // Standard: Total tax deducted from user = 12%. 
                // INPS (0.1%) is usually INSIDE that 12%. 
                // Net = Gross - (Gross * 0.12).

                const tax = gross * 0.12;
                const inps = gross * 0.001; // Just for display (Send to Xalq Bank)
                const net = gross - tax;
                const social = gross * 0.12; // 12% Employer expense

                return {
                    id: e.id,
                    name: e.name,
                    gross: gross,
                    tax: tax,
                    inps: inps,
                    net: net,
                    social: social
                };
            });

            payrolls[m] = newData;
            localStorage.setItem('k_payrolls', JSON.stringify(payrolls));
            renderPayrollTable(newData);
        }

        function renderPayrollTable(data) {
            const tbody = document.getElementById('pay-tbody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Ma\'lumot yo\'q. "Hisoblash" tugmasini bosing.</td></tr>';
                document.getElementById('t-gross').innerHTML = 0;
                return;
            }

            let totals = { g: 0, t: 0, i: 0, n: 0, s: 0 };

            tbody.innerHTML = data.map((r, i) => {
                totals.g += r.gross;
                totals.t += r.tax;
                totals.i += r.inps;
                totals.n += r.net;
                totals.s += r.social;

                return `
                <tr>
                    <td>${i + 1}</td>
                    <td><b>${r.name}</b></td>
                    <td class="num">${r.gross.toLocaleString()}</td>
                    <td class="num">${r.tax.toLocaleString()}</td>
                    <td class="num">${r.inps.toLocaleString()}</td>
                    <td class="num" style="font-weight:bold; color:var(--primary-color);">${r.net.toLocaleString()}</td>
                    <td class="num" style="background:#fefce8;">${r.social.toLocaleString()}</td>
                    <td class="no-print">
                        <button onclick="editPay('${r.id}')" class="btn-ghost btn" style="font-size:0.7rem;">‚úèÔ∏è</button>
                    </td>
                    <td class="print-only" style="display:none; border-bottom:1px solid #000;"></td>
                </tr>
                `;
            }).join('');

            document.getElementById('t-gross').innerHTML = totals.g.toLocaleString();
            document.getElementById('t-tax').innerHTML = totals.t.toLocaleString();
            document.getElementById('t-inps').innerHTML = totals.i.toLocaleString();
            document.getElementById('t-net').innerHTML = totals.n.toLocaleString();
            document.getElementById('t-social').innerHTML = totals.s.toLocaleString();
        }

        function editPay(id) {
            const m = document.getElementById('pay-month').value;
            const data = payrolls[m];
            const row = data.find(r => r.id == id);

            const newGross = prompt(`${row.name} uchun Hisoblangan Oylikni (Gross) kiriting:`, row.gross);
            if (newGross === null) return;

            const g = parseFloat(newGross) || 0;
            // Recalc
            row.gross = g;
            row.tax = g * 0.12;
            row.inps = g * 0.001;
            row.net = g - row.tax;
            row.social = g * 0.12;

            localStorage.setItem('k_payrolls', JSON.stringify(payrolls));
            renderPayrollTable(data);
        }

    </script>

</body>

</html>